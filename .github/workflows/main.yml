name: Build, Test, Lint

on: [push, pull_request]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# see https://github.com/mesonbuild/meson/blob/master/docs/markdown/Continuous-Integration.md
# Note: I've moved MinGW & Windows to the top because they are the slowest
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: clang-tidy
          version: 1.0
      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"
          cache: "pip"
      - run: ./scripts/lint/lint-version.py
      - run: ./scripts/lint/lint-clang-tidy.py

  mingw:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        sys: [mingw64, mingw32]
        cxx_standard: [17, 23]
        include:
          - sys: mingw64
            arch_name: "64bit"
            msystem: MINGW64
            prefix: mingw-w64-x86_64
          - sys: mingw32
            arch_name: "32bit"
            msystem: MINGW32
            prefix: mingw-w64-i686
    name: MinGW (C++${{ matrix.cxx_standard }}, ${{ matrix.arch_name }})
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v5
      - uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msystem }}
          update: true
          cache: true
          install: >-
            ca-certificates
            ${{ matrix.prefix }}-ca-certificates
            ${{ matrix.prefix }}-gcc
            ${{ matrix.prefix }}-meson
            ${{ matrix.prefix }}-ninja
            ${{ matrix.prefix }}-python
            ${{ matrix.prefix }}-python-pip
      - name: Print compiler version
        run: g++ --version
      - run: meson setup builddir -Dcpp_std=c++${{ matrix.cxx_standard }}
      - run: meson test -C builddir -v
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: MinGW_${{ matrix.arch_name }}_cpp${{ matrix.cxx_standard }}_Testlog
          path: builddir/meson-logs/testlog.txt
          retention-days: 7

  windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, x86]
        cxx_standard: [17, latest]
        include:
          - arch: x64
            arch_name: "64bit"
          - arch: x86
            arch_name: "32bit"
    name: Windows (C++${{ matrix.cxx_standard }}, ${{ matrix.arch_name }})
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"
          cache: "pip"
      - run: pip install ninja meson
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}
      - name: Print compiler version
        run: cl
      - run: meson setup builddir -Dcpp_std=c++${{ matrix.cxx_standard }}
      - run: meson test -C builddir -v
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: Windows_${{ matrix.arch_name }}_cpp${{ matrix.cxx_standard }}_Testlog
          path: |
            builddir/meson-logs/testlog.txt
            builddir/test/udm-test.exe
          retention-days: 7

  windows-module:
    runs-on: windows-latest
    name: Windows Modules (C++20, 64bit)
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"
          cache: "pip"
      - run: pip install ninja
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '4.x'
      - name: Print compiler version
        run: cl
      - run: cmake -G Ninja -DANKERL_ENABLE_EXAMPLE=TRUE -DANKERL_ENABLE_MODULES=TRUE -B build
      - run: cmake --build build --verbose
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: Windows_64bit_cpp23-modules_Testlog
          path: |
            builddir/meson-logs/testlog.txt
            builddir/test/udm-test.exe
          retention-days: 7

  macos:
    runs-on: macos-latest
    strategy:
      matrix:
        cxx_standard: [17, 23]
    name: macOS (C++${{ matrix.cxx_standard }}, arm64bit)
    steps:
      - uses: actions/checkout@v5
      - uses: hendrikmuhs/ccache-action@v1.2.19
        with:
          key: clang-cpp${{ matrix.cxx_standard }}-arm64bit
      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"
          cache: "pip"
      - run: brew install gcc ccache meson ninja
      - name: Print compiler versions
        run: c++ --version
      - run: meson setup builddir/ -Dcpp_std=c++${{ matrix.cxx_standard }}
        env:
          CXX: ccache c++
      - run: meson test -C builddir/ -v
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: MacOS_cpp${{ matrix.cxx_standard }}_Meson_Testlog
          path: builddir/meson-logs/testlog.txt
          retention-days: 7

  linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        cxx_standard: [17, 23]
        arch: [64, 32]
        include:
          - compiler: gcc
            cc: gcc
            cxx: g++
          - compiler: clang
            cc: clang
            cxx: clang++
          - arch: 64
            arch_flags: ""
            packages: libboost-dev libfmt-dev ccache
          - arch: 32
            arch_flags: "-m32"
            packages: "libboost-dev gcc-multilib g++-multilib"
    name: Linux (${{ matrix.compiler }}, C++${{ matrix.cxx_standard }}, ${{ matrix.arch }}bit)
    steps:
      - uses: actions/checkout@v5
      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: ${{ matrix.packages }} ccache
          version: 1.0
      - uses: hendrikmuhs/ccache-action@v1.2.19
        with:
          key: ${{ matrix.compiler }}-cpp${{ matrix.cxx_standard }}-${{ matrix.arch }}bit
      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"
          cache: "pip"
      - run: pip install meson ninja
      - name: Print compiler versions
        run: |
          ${{ matrix.cc }} --version
          ${{ matrix.cxx }} --version
      - run: meson setup builddir/ -Dcpp_std=c++${{ matrix.cxx_standard }}
        env:
          CC: ccache ${{ matrix.cc }}
          CXX: ccache ${{ matrix.cxx }}
          CFLAGS: ${{ matrix.arch_flags }}
          CXXFLAGS: ${{ matrix.arch_flags }}
          LDFLAGS: ${{ matrix.arch_flags }}
      - run: meson test -C builddir/ -v
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: Linux_${{ matrix.compiler }}_cpp${{ matrix.cxx_standard }}_${{ matrix.arch }}bit_Testlog
          path: builddir/meson-logs/testlog.txt
          retention-days: 7

  linux-modules:
    runs-on: ubuntu-latest
    name: Linux Modules (clang, C++20, 64bit)
    steps:
      - uses: actions/checkout@v5
      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libboost-dev libfmt-dev
          version: 1.0
      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"
          cache: "pip"
      - run: pip install ninja
      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '4.x'
      - name: Print compiler versions
        run: |
          clang --version
          clang++ --version
      - run: cmake -G Ninja -DANKERL_ENABLE_EXAMPLE=TRUE -DANKERL_ENABLE_MODULES=TRUE -B build
        env:
          CC: clang
          CXX: clang++
          CFLAGS: -m64
          CXXFLAGS: -m64
          LDFLAGS: -m64
      - run: cmake --build build --verbose
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: Linux_clang_cpp23-modules_64bit_Testlog
          path: builddir/meson-logs/testlog.txt
          retention-days: 7

  linux-sanitizers:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        sanitizer: [address, thread, undefined]
        include:
          - compiler: gcc
            cc: gcc
            cxx: g++
          - compiler: clang
            cc: clang
            cxx: clang++
          - sanitizer: address
            sanitizer_flags: "-fsanitize=address -fno-omit-frame-pointer"
          - sanitizer: thread
            sanitizer_flags: "-fsanitize=thread"
          - sanitizer: undefined
            sanitizer_flags: "-fsanitize=undefined"
    name: Linux Sanitizer (${{ matrix.compiler }}, ${{ matrix.sanitizer }})
    steps:
      - uses: actions/checkout@v5
      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libboost-dev libfmt-dev ccache
          version: 1.0
      - uses: hendrikmuhs/ccache-action@v1.2.19
        with:
          key: ${{ matrix.compiler }}-sanitize-${{ matrix.sanitizer }}
      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"
          cache: "pip"
      - run: pip install meson ninja
      - name: Print compiler versions
        run: |
          ${{ matrix.cc }} --version
          ${{ matrix.cxx }} --version
      - run: meson setup builddir/ -Dcpp_std=c++17 -Db_sanitize=${{ matrix.sanitizer }}
        env:
          CC: ccache ${{ matrix.cc }}
          CXX: ccache ${{ matrix.cxx }}
      - run: meson test -C builddir/ -v
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: Linux_${{ matrix.compiler }}_sanitize_${{ matrix.sanitizer }}_Testlog
          path: builddir/meson-logs/testlog.txt
          retention-days: 7

  linux-arm64:
    runs-on: ubuntu-24.04-arm64
    if: false # Disabled for now due to long queue times
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        cxx_standard: [17, 23]
        include:
          - compiler: gcc
            cc: gcc
            cxx: g++
          - compiler: clang
            cc: clang
            cxx: clang++
    name: Linux ARM64 (${{ matrix.compiler }}, C++${{ matrix.cxx_standard }})
    steps:
      - uses: actions/checkout@v5
      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libboost-dev libfmt-dev ccache
          version: 1.0
      - uses: hendrikmuhs/ccache-action@v1.2.19
        with:
          key: arm64-${{ matrix.compiler }}-cpp${{ matrix.cxx_standard }}
      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"
          cache: "pip"
      - run: pip install meson ninja
      - name: Print compiler versions
        run: |
          ${{ matrix.cc }} --version
          ${{ matrix.cxx }} --version
      - run: meson setup builddir/ -Dcpp_std=c++${{ matrix.cxx_standard }}
        env:
          CC: ccache ${{ matrix.cc }}
          CXX: ccache ${{ matrix.cxx }}
      - run: meson test -C builddir/ -v
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: Linux_ARM64_${{ matrix.compiler }}_cpp${{ matrix.cxx_standard }}_Testlog
          path: builddir/meson-logs/testlog.txt
          retention-days: 7
